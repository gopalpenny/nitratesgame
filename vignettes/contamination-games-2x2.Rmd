---
title: "contamination-games-2x2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{contamination-games-2x2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(nitratesgame)
library(dplyr)
library(tidyr)
library(purrr)
library(tibble)
library(ggplot2)
library(patchwork)
```

A simple example

```{r fig.width = 4, fig.height = 2}
payouts <- get_2x2_payouts(1, 1, 2, 3)
get_2x2_ggplot(payouts, TRUE)
```

Matrices of games

```{r fig.width = 7, fig.height = 6}
games <- crossing(tA = 1:4, tB = 1:4, nesting(tibble(Cs=c(2,3),Cd=c(3,2)))) %>%
  # filter(tA <= tB) %>%
  rowwise() %>%
  mutate(payouts = list(get_2x2_payouts(tA=tA, tB=tB, Cs=Cs, Cd=Cd))) %>%
  ungroup() %>%
  mutate(plots = map(payouts, function(x) get_2x2_ggplot(x, TRUE)))

# ggsave("nitrates_2player_games_sym.eps", games %>% filter(tA == tB) %>% pull(plots), 
#        path = out_path, width = 6, height = 6)
# ggsave("nitrates_2player_games_asym.eps", games %>% filter(tA <= tB) %>% pull(plots), 
#        path = out_path, width = 6, height = 9)

games %>% filter(Cd == 3) %>% pull(plots) %>%
  patchwork::wrap_plots(ncol = 4)
```

```{r}
# The households / septic configurations
mixed_configurations <- tribble(~config, ~tA, ~tB, ~prob_name, ~dir,
                           1, 3, 1, "p1", "E",
                           1, 2, 4, "p2", "W",
                           1, 1, 1, "p3", "N/S",
                           2, 3, 2, "p1", "E",
                           2, 2, 3, "p2", "W",
                           2, 1, 1, "p3", "N/S",
                           3, 4, 1, "p1", "E",
                           3, 1, 4, "p2", "W",
                           3, 1, 1, "p3", "N/S",
                           4, 3, 1, "p1", "E",
                           4, 1, 3, "p2", "W",
                           4, 1, 2, "p3", "S",
                           5, 4, 4, "p1", "E",
                           5, 1, 1, "p2", "W",
                           5, 1, 1, "p3", "N/S")
realizations <- crossing(p1 = seq(0, 1, by = 1/10), p2 = seq(0, 1, by = 1/10)) %>% 
  filter(p1 + p2 <= 1) %>%
  mutate(p3 = round(1 - p1 - p2,10),
         id = row_number())
realizations_long <- realizations %>% pivot_longer(cols = matches("^p[1-4]$"), names_to = "prob_name", values_to = "prob")

mixed_solutions_prep1 <- mixed_configurations %>% crossing(Cd = c(1.5,2,3), Cs = 1, realizations[,"id"]) %>%
  arrange(id, prob_name) %>%
  left_join(realizations_long, by = c("prob_name", "id")) %>%
  rowwise() %>%
  mutate(payouts = list(get_2x2_payouts(tA, tB, Cs, Cd))) %>%
  group_by(config, id, Cd, Cs) %>%
  summarize(mixed = list(get_2x2_weighted_payouts(payouts, prob))) %>%
  ungroup()# %>%
  # mutate(solutions = map(mixed, get_2x2_game_solutions),
  #        NE = map(mixed, function(x) get_2x2_game_solutions(x, "NE")),
  #        FB = map(mixed, function(x) get_2x2_game_solutions(x, "FB"))) %>%
mixed_solutions_prep2 <- mixed_solutions_prep1 %>% 
  mutate(game_dilemma = map(mixed, function(x) get_2x2_game_solutions(x, "dilemma")),
         game_type = map(mixed, function(x) get_2x2_game_solutions(x, "type"))) %>%
  left_join(realizations, by = c("id")) %>%
  unnest(c("game_type","game_dilemma"))


reorder_gametypes <- function(gametype) {
  types <- strsplit(gametype, "-")
  type_reorder <- sapply(types, function(x) paste(sort(x), collapse = "-"))
}
mixed_solutions <- mixed_solutions_prep2 %>% 
  mutate(gametype_reorder = reorder_gametypes(game_type),
         Cd_lab = paste0("Cd = ",Cd,"*Cs"))

mixed_solutions %>% mutate(type = paste0("NE:",NE,"/","FB:",FB)) %>% 
  filter(NE != FB) %>% pull(type) %>% unique()
```


```{r fig.height = 6, fig.width=6}
ggplot(mixed_solutions) + 
  geom_tile(aes(p1, p2, fill = gametype_reorder), color = "#555555", size = 0.25) +
  geom_tile(aes(p1, p2, color = game_dilemma), fill = NA, size = 0.5) +
  scale_x_continuous("Pr(East)",breaks = seq(0,1, by =0.2)) +
  scale_y_continuous("Pr(West)",breaks = seq(0,1, by =0.2)) +
  scale_alpha_manual(values = c(0.4,1)) +
  scale_color_manual(values = c(NA,"black")) +
  facet_grid(config~Cd_lab) + coord_equal() + ggp::t_manu()

```

```{r}
config5 <- mixed_solutions %>% filter(Cd == 2, config == 5, p1 == 1) %>%
  unnest("mixed")
get_2x2_ggplot(config5, T)
```

```{r fig.height = 5, fig.width = 7}
mixed_solutions %>% mutate(type = paste0("NE:",NE,"/","FB:",FB)) %>% 
  filter(NE != FB) %>% group_by(type) %>%
  mutate(type_rank = row_number()) %>%
  filter(type_rank == 1) %>%
  mutate(plots = map(mixed, function(x) get_2x2_ggplot(x, TRUE))) %>%
  pull(plots) %>%
  patchwork::wrap_plots()
```

